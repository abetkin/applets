<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://abetkin.github.io/gcontext/examples/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Examples - gcontext</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">gcontext</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li class="active">
                        <a href=".">Examples</a>
                    </li>
                
                
                </ul>
            

            
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                
                <li >
                    <a rel="next" href="..">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li class="disabled">
                    <a rel="prev" >
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                
                <li>
                    <a href="https://github.com/abetkin/gcontext">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
            
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#examples">Examples</a></li>
        
            <li><a href="#subtest-feature">Subtest feature</a></li>
        
            <li><a href="#django-filters-enhanced">"Django filters" enhanced</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="examples">Examples</h1>
<p>The examples collection.</p>
<hr />
<h2 id="subtest-feature">Subtest feature</h2>
<p>In the standard
library there is nice <code>unittest</code> package. It used to have, however, two annoyingly missing features:
running subtests and dropping into debugger on failures. Now there is only one since
the first problem was successfully solved in 3.4 release.</p>
<p>Lets try to reimplement this "subtest" feature
using <code>gcontext</code>. For those who haven't read that part of <code>unittest</code> documentation,
this is what the original looks like:</p>
<pre><code>class MyTest(unittest.TestCase):
    def test(self):
        with self.subTest('this will fail'):
            self.assertTrue(False)
</code></pre>
<p>Here is the proposed solution. We want subtests to use the same test result their parent does so
we push it into the context. Also we push <code>{'testcase': self}</code>: subtests should know
their parents.</p>
<pre><code>import gcontext as g

class TestCase(unittest.TestCase):

    def run(self, result):
        with g.add_context({'result': result, 'testcase': self}):
            return super().run(result)
</code></pre>
<p>Here is our subtest class:</p>
<pre><code>class SubTest(unittest.TestCase):

    parent = g.ContextAttr('testcase')

    def __init__(self, description):
        super().__init__()
        self._name = '%s [%s]' % (self.parent, description)

    def __str__(self):
        return self._name

    def runTest(self):
        extype, ex, tb = sys.exc_info()
        if extype:
            raise extype.with_traceback(ex, tb)
</code></pre>
<p>It's <code>runTest</code> does almost nothing: the actual testing code will be run inside the <code>subTest</code>
context manager. It just reraises the last exception that will now be caught by
<code>TestCase.run</code>. Now namely the context manager:</p>
<pre><code>class subTest(ContextDecorator):

    result = g.ContextAttr('result')

    def __init__(self, description):
        self._description = description

    def __enter__(self):
        self._case = SubTest(self._description)
        self._context_cm = g.add_context({'testcase': self._case})
        self._context_cm.__enter__()

    def __exit__(self, *exc_info):
        self._context_cm.__exit__(*exc_info)
        self._case.run(self.result)
        return True
</code></pre>
<p>All subtests also push <code>{'testcase': self}</code> to make a hierarchy.</p>
<p>Now, how this <code>subTest</code> is different from the original?                <br />
First, our subtests are nested,
while in the original version they are not (we benefit from this fact only in <code>__str__</code> function).
Also, they are not required to be accessed
from the testcase instance, which allows us to write things like</p>
<pre><code>class TC(TestCase):

    @subTest('a method')
    def amethod(self):
        self.assertTrue(False)

    def test(self):
        with subTest('hierarchy'):
            with subTest('is honoured'):
                self.assertFalse(True)
        afunction()
        self.amethod()

def case():
    return g.get_context()['testcase']

@subTest('a function')
def afunction():
    case().assertEqual(1 + 1, 2)
</code></pre>
<p><em>Note:</em> This is just an example, it doesn't have any real advantages for writing unit tests.</p>
<hr />
<h2 id="django-filters-enhanced">"Django filters" enhanced</h2>
<p>No, we won't fork django. It will be an "enhanced" version compared to <a href="http://abetkin.github.io/declared/examples/#django-filters">"Django Filters"</a>
example from the <strong><a href="http://abetkin.github.io/declared/">declared</a></strong>
package. Enhanced is put within the quotation marks because it can turn otherwise if used excessively without need.</p>
<p>In "Django Filters" we have written base classes for filters declaration that can be nested. A filter there is a callable that takes
iterable (a queryset) as a parameter and returns iterable. Let's modify that example, so that it will take queryset from the context
if it's not specified:</p>
<pre><code>@qsfilter.register
class FiltersDeclaredMeta(DeclaredMeta, abc.ABCMeta):
    def __repr__(cls):
        return ', '.join(cls._declared_filters.keys())

    objects = g.ContextAttr('queryset')
</code></pre>
<p>We have added <code>objects</code> property to the metaclass so it will be accessible from the filter's class.</p>
<p>Now we can use it in filters' implementations:</p>
<pre><code>class CascadeFilter(DeclaredFilters):
    @classmethod
    def filter(cls, objects=None):
        if objects is None:
            objects = cls.objects
        for f in cls._declared_filters.values():
            objects = f.filter(objects)
        return objects

class ReduceFilters(DeclaredFilters):
    @classmethod
    def filter(cls, objects=None):
        if objects is None:
            objects = cls.objects
        filters = [f.filter(objects) for f in cls._declared_filters.values()]
        if filters:
            return reduce(cls.operation, filters)
        return objects
</code></pre>
<p>Notice the fallback to <code>cls.objects</code> if the queryset wasn't passed.</p>
<p>Actually, the queryset is less global than, say, the request object, so the property should not be used often.
The ability to call such routines without arguments should be used in corner cases, when they are hardly accessible and
the routine plays secondary, accesory role. Like in the example below:  </p>
<pre><code>from declared import declare
from django.db.models import Q

class MyFilters(Filter):

    class Fields(Serializer):
        text = CharField()
        title = CharField()

    def __init__(self):
        self.params = self.Fields.deserialize()
        self.process_declared()

    @declare()
    def text(self):
        return Q(text__icontains=self.params['text'])
</code></pre>
<p>We have used <code>Serializer</code> class to deserialize <code>Filter</code> arguments. It's very convenient that it's <code>deserialize</code> function can take no arguments.</p>
<p>Likewise, filtering can play such auxiliary role somewhere else. And the ability to use <code>queryset</code> attribute set, say, on the view
can be very convenient.</p></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>